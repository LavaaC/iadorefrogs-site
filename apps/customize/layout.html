<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Customize</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>

    html,body{height:100%;overflow:hidden}
    body{margin:0;padding:10px;font:13px Tahoma,"MS Sans Serif",Arial,sans-serif;background:#fff;color:#000;display:flex;flex-direction:column}
    #apps{flex:1;overflow:auto}
    .row{display:flex;align-items:center;gap:8px;margin-bottom:4px}
    .row img{width:16px;height:16px}
    .name{min-width:80px}
    .row input[type=number]{width:40px}
    label{margin-right:10px}
    button{background:#c0c0c0;border:2px outset #fff;padding:2px 6px;cursor:pointer}
    button:active{border:2px inset #fff}
    .buttons{display:flex;gap:8px;margin-top:8px;flex-shrink:0}

  </style>
</head>
<body>
  <div id="apps">Loading...</div>

    <div class="buttons">
      <button id="save">Save</button>
    </div>
  <script>
    async function load(){

      try{
        return (await window.top.loadSettings?.()) || {};
      }catch{
        return {};
      }

    }
    async function save(s){
      try{await window.top.saveSettings?.(s);}catch{}
    }

    async function init(){
      if(!window.top.currentUser?.username){
        document.body.innerHTML='<p>Please log in to customize.</p>';
        return;
      }
      const listEl=document.getElementById('apps');
      let ids=[];
      try{ ids=await (await fetch('../apps.json')).json(); }
      catch{ listEl.textContent='Failed to load apps.'; return; }
      const settings=await load();

      const metas={};
      await Promise.all(ids.map(async id=>{ try{ metas[id]=await (await fetch(`../${id}/app.json`)).json(); }catch{} }));

      const order=(settings.pinnedOrder&&settings.pinnedOrder.filter(id=>ids.includes(id)))||ids.slice();
      ids.forEach(id=>{if(!order.includes(id)) order.push(id);});
      listEl.textContent='';
      order.forEach(id=>{
        const s=settings[id]||{};
        const meta=metas[id]||{};
        const title=meta.title||id;
        const icon=meta.icon?(meta.icon.startsWith('/')||meta.icon.startsWith('http')?meta.icon:`../${id}/${meta.icon}`):`../assets/apps/${id}/icon.png`;
        const posX = s.x ?? meta.x ?? '';
        const posY = s.y ?? meta.y ?? '';
        const row=document.createElement('div');
        row.className='row';
        row.dataset.id=id;
        row.innerHTML=`<img src="${icon}" alt="">`+
          `<span class="name">${title}</span>`+
          `<button class="up">\u25B2</button><button class="down">\u25BC</button>`+
          `<label>X:<input type="number" class="x" value="${posX}"></label>`+
          `<label>Y:<input type="number" class="y" value="${posY}"></label>`+
          `<label><input type="checkbox" class="show" ${s.show!==false?'checked':''}> Show</label>`+
          `<label><input type="checkbox" class="pin" ${s.pinned?'checked':''}> Pin</label>`;
        listEl.appendChild(row);
      });
      listEl.addEventListener('click',e=>{
        const row=e.target.closest('.row');
        if(!row) return;
        if(e.target.classList.contains('up')){
          const prev=row.previousElementSibling; if(prev) listEl.insertBefore(row,prev);
        }
        if(e.target.classList.contains('down')){
          const next=row.nextElementSibling; if(next) listEl.insertBefore(next,row);
        }
      });
      document.getElementById('save').onclick=async()=>{
        const s=await load();
        Array.from(listEl.children).forEach(row=>{
          const id=row.dataset.id;
          s[id]=s[id]||{};
          s[id].show=row.querySelector('.show').checked;
          s[id].pinned=row.querySelector('.pin').checked;
          const xVal=parseInt(row.querySelector('.x').value,10);
          const yVal=parseInt(row.querySelector('.y').value,10);
          if(!isNaN(xVal)) s[id].x=xVal; else delete s[id].x;
          if(!isNaN(yVal)) s[id].y=yVal; else delete s[id].y;
        });
        s.pinnedOrder=Array.from(listEl.children).map(r=>r.dataset.id);
        await save(s);
        await window.top.applyDesktopSettings?.();
        window.top.WM?.close('customize');
      };

      if(!listEl.children.length){
        listEl.textContent='No apps available.';
      }
    }
    init().catch(()=>{
      const listEl=document.getElementById('apps');
      listEl.textContent='Failed to load customization.';
    });
  </script>
</body>
</html>

